# G.711 A-law 杂音问题修复说明

## 问题分析

你遇到的杂音问题很可能是由于 **A-law 编码算法实现不正确** 导致的。

### 原始问题
- 文件显示为 "13-bit" 精度（这实际上是正常的，A-law 内部使用 13-bit 对数表示）
- 播放时有杂音

### 根本原因
原来的编码算法使用了简化的查找表方法，但实现有误，导致编码结果不符合 ITU-T G.711 标准。

## 已修复内容

### 1. 更新了 `audio_streamer_glue.cpp`
使用标准的 ITU-T G.711 A-law 编码算法：
- 正确处理符号位
- 正确计算段号（segment）
- 正确应用量化和掩码

### 2. 更新了 `convert_to_alaw.cpp`
独立转换工具也使用相同的标准算法。

### 3. 创建了测试工具
- `test_alaw_encoding.cpp`: 测试编码/解码的正确性
- `diagnose_wav.sh`: 诊断 WAV 文件格式

## 验证步骤

### 步骤 1: 测试编码算法

```bash
# 编译测试程序
g++ -o test_alaw test_alaw_encoding.cpp -std=c++11

# 运行测试
./test_alaw
```

**预期输出**:
```
G.711 A-law 编码测试

测试标准值:

   输入 PCM    A-law (hex)      解码 PCM        误差  描述
----------------------------------------------------------------------
           0           0xd5              0           0  静音
         100           0xd2             96           4  小正值
        -100           0x52            -96          -4  小负值
        1000           0xe5           1008          -8  中等正值
       -1000           0x65          -1008           8  中等负值
       10000           0xf9          10032        -32  大正值
      -10000           0x79         -10032          32  大负值
       32767           0xff          32256         511  最大正值
      -32768           0x7f         -32256        -512  最大负值
```

如果看到类似输出，说明编码算法正确。

### 步骤 2: 重新编译模块

```bash
cd build
cmake -DCMAKE_BUILD_TYPE=Release ..
make
sudo make install
```

### 步骤 3: 测试生成的文件

生成新的 WAV 文件后，使用诊断脚本检查：

```bash
bash diagnose_wav.sh your_file.wav
```

**预期输出**:
```
==========================================
WAV 文件诊断: your_file.wav
==========================================

1. 文件类型检测:
your_file.wav: RIFF (little-endian) data, WAVE audio, ITU G.711 A-law, mono 8000 Hz

...

5. 标准检查:
   ✓ 格式码正确 (A-law)
   ✓ 声道数正确 (单声道)
   ✓ 采样率正确 (8000 Hz)
   ✓ 位深度正确 (8 bit)

==========================================
结果: 文件格式完全正确 ✓
==========================================
```

### 步骤 4: 播放测试

```bash
# 使用不同的播放器测试
aplay your_file.wav
ffplay your_file.wav
play your_file.wav  # SoX
```

## 关于 "13-bit" 显示

SoX 显示 "Precision: 13-bit" 是 **正常的**，不是错误：

- G.711 A-law 内部使用 13-bit 对数压缩
- 存储格式是 8-bit
- 这是 A-law 标准的一部分
- 不会影响播放质量

## 标准 A-law 编码流程

```
16-bit PCM 输入
    ↓
取符号位和绝对值
    ↓
右移 3 位 (16-bit → 13-bit)
    ↓
查找段号 (0-7)
    ↓
段内量化 (4-bit)
    ↓
组合: [符号位][段号3bit][量化值4bit]
    ↓
应用 XOR 掩码
    ↓
8-bit A-law 输出
```

## 音质说明

G.711 A-law 是有损压缩，会有量化误差：
- **小信号**: 误差约 ±4 到 ±8
- **中等信号**: 误差约 ±8 到 ±32
- **大信号**: 误差约 ±32 到 ±512

这是正常的，符合标准。对于语音通话，这个误差是可接受的。

## 如果仍有问题

### 1. 检查输入数据
```bash
# 查看原始 PCM 数据的前几个样本
hexdump -C input.raw | head -n 5
```

### 2. 对比标准实现
可以使用 FFmpeg 转换作为参考：
```bash
# 使用 FFmpeg 转换
ffmpeg -f s16le -ar 8000 -ac 1 -i input.raw -acodec pcm_alaw output_ref.wav

# 对比你的输出
diff <(hexdump -C output_ref.wav) <(hexdump -C your_output.wav)
```

### 3. 检查重采样
如果输入不是 8000 Hz，确保 SpeexDSP 重采样正确：
```cpp
// 在代码中添加日志
switch_log_printf(..., "Resampling: %d Hz -> 8000 Hz, samples: %zu -> %zu\n",
                  sampleRate, input_samples, out_len);
```

## 总结

修复后的代码使用标准 ITU-T G.711 A-law 算法，应该能够生成正确的音频文件。如果仍有杂音：

1. 先运行 `./test_alaw` 确认编码器正确
2. 使用 `diagnose_wav.sh` 检查文件格式
3. 检查输入数据是否正常
4. 对比 FFmpeg 的输出

如果测试程序显示编码正确，文件格式也正确，但仍有杂音，可能是输入数据本身的问题。
