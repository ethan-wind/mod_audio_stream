# audio_streamer_glue.cpp 日志增强说明

## 修改概述

在 `audio_streamer_glue.cpp` 的播放相关逻辑中添加了详细的日志记录，便于调试和监控音频文件生成及事件推送过程。

---

## 一、新增日志位置

### 1.1 消息处理入口（processMessage 函数）

**位置**：接收到 WebSocket 消息时

**新增日志**：
```cpp
// JSON 解析失败
switch_log_printf(SWITCH_CHANNEL_SESSION_LOG(session), SWITCH_LOG_ERROR, 
                  "(%s) processMessage - failed to parse JSON message\n",
                  m_sessionId.c_str());

// 消息类型识别
switch_log_printf(SWITCH_CHANNEL_SESSION_LOG(session), SWITCH_LOG_DEBUG, 
                  "(%s) processMessage - received message type: %s\n",
                  m_sessionId.c_str(), jsType ? jsType : "null");
```

**日志级别**：
- `ERROR`：JSON 解析失败
- `DEBUG`：消息类型识别

**示例输出**：
```
[DEBUG] (12345-uuid) processMessage - received message type: streamAudio
```

---

### 1.2 音频类型验证

**位置**：检查 audioDataType 字段

**新增日志**：
```cpp
// 缺少 audioDataType
switch_log_printf(SWITCH_CHANNEL_SESSION_LOG(session), SWITCH_LOG_ERROR, 
                  "(%s) processMessage - missing audioDataType in streamAudio message\n",
                  m_sessionId.c_str());

// 文件类型确定失败
switch_log_printf(SWITCH_CHANNEL_SESSION_LOG(session), SWITCH_LOG_ERROR, 
                  "(%s) processMessage - failed to determine file type for audioDataType: %s\n",
                  m_sessionId.c_str(), jsAudioDataType);
```

**日志级别**：`ERROR`

**示例输出**：
```
[ERROR] (12345-uuid) processMessage - missing audioDataType in streamAudio message
[ERROR] (12345-uuid) processMessage - failed to determine file type for audioDataType: unknown
```

---

### 1.3 音频数据接收

**位置**：开始处理 streamAudio 消息

**新增日志**：
```cpp
switch_log_printf(SWITCH_CHANNEL_SESSION_LOG(session), SWITCH_LOG_INFO, 
                  "(%s) processMessage - received streamAudio, type: %s, sampleRate: %d\n",
                  m_sessionId.c_str(), jsAudioDataType, sampleRate);
```

**日志级别**：`INFO`

**示例输出**：
```
[INFO] (12345-uuid) processMessage - received streamAudio, type: raw, sampleRate: 8000
[INFO] (12345-uuid) processMessage - received streamAudio, type: wav, sampleRate: 0
```

---

### 1.4 Base64 解码

**位置**：解码音频数据

**新增日志**：
```cpp
// 解码成功
switch_log_printf(SWITCH_CHANNEL_SESSION_LOG(session), SWITCH_LOG_DEBUG, 
                  "(%s) processMessage - base64 decoded, size: %zu bytes\n",
                  m_sessionId.c_str(), rawAudio.size());

// 解码失败（已存在）
switch_log_printf(SWITCH_CHANNEL_SESSION_LOG(session), SWITCH_LOG_ERROR, 
                  "(%s) processMessage - base64 decode error: %s\n",
                  m_sessionId.c_str(), e.what());
```

**日志级别**：
- `DEBUG`：解码成功
- `ERROR`：解码失败

**示例输出**：
```
[DEBUG] (12345-uuid) processMessage - base64 decoded, size: 3200 bytes
[ERROR] (12345-uuid) processMessage - base64 decode error: Invalid base64 character
```

---

### 1.5 文件保存

**位置**：保存音频文件到磁盘

**新增日志**：
```cpp
// 开始保存
switch_log_printf(SWITCH_CHANNEL_SESSION_LOG(session), SWITCH_LOG_INFO, 
                  "(%s) processMessage - saving audio to file: %s\n",
                  m_sessionId.c_str(), filePath);

// 保存成功
switch_log_printf(SWITCH_CHANNEL_SESSION_LOG(session), SWITCH_LOG_INFO, 
                  "(%s) processMessage - audio file saved successfully, size: %zu bytes\n",
                  m_sessionId.c_str(), rawAudio.size());
```

**日志级别**：`INFO`

**示例输出**：
```
[INFO] (12345-uuid) processMessage - saving audio to file: /tmp/12345-uuid_0.tmp.r8
[INFO] (12345-uuid) processMessage - audio file saved successfully, size: 3200 bytes
```

---

### 1.6 事件推送

**位置**：触发 EVENT_PLAY 事件

**新增日志**：
```cpp
// 准备触发事件
switch_log_printf(SWITCH_CHANNEL_SESSION_LOG(session), SWITCH_LOG_INFO, 
                  "(%s) processMessage - triggering EVENT_PLAY event\n",
                  m_sessionId.c_str());

// 事件数据（仅在未抑制日志时）
if(!m_suppress_log) {
    switch_log_printf(SWITCH_CHANNEL_SESSION_LOG(session), SWITCH_LOG_DEBUG, 
                      "(%s) processMessage - EVENT_PLAY data: %s\n",
                      m_sessionId.c_str(), jsonString);
}

// 事件触发成功
switch_log_printf(SWITCH_CHANNEL_SESSION_LOG(session), SWITCH_LOG_INFO, 
                  "(%s) processMessage - EVENT_PLAY event fired successfully\n",
                  m_sessionId.c_str());
```

**日志级别**：
- `INFO`：事件触发状态
- `DEBUG`：事件详细数据（受 STREAM_SUPPRESS_LOG 控制）

**示例输出**：
```
[INFO] (12345-uuid) processMessage - triggering EVENT_PLAY event
[DEBUG] (12345-uuid) processMessage - EVENT_PLAY data: {"audioDataType":"raw","sampleRate":8000,"file":"/tmp/12345-uuid_0.tmp.r8"}
[INFO] (12345-uuid) processMessage - EVENT_PLAY event fired successfully
```

---

### 1.7 文件清理

**位置**：deleteFiles 函数

**新增日志**：
```cpp
// 开始清理
switch_log_printf(SWITCH_CHANNEL_LOG, SWITCH_LOG_INFO, 
                  "(%s) deleteFiles - cleaning up %zu temporary audio files\n",
                  m_sessionId.c_str(), m_Files.size());

// 每个文件的删除结果
switch_log_printf(SWITCH_CHANNEL_LOG, SWITCH_LOG_DEBUG, 
                  "(%s) deleteFiles - deleted: %s\n",
                  m_sessionId.c_str(), fileName.c_str());

// 删除失败
switch_log_printf(SWITCH_CHANNEL_LOG, SWITCH_LOG_WARNING, 
                  "(%s) deleteFiles - failed to delete: %s\n",
                  m_sessionId.c_str(), fileName.c_str());

// 清理完成
switch_log_printf(SWITCH_CHANNEL_LOG, SWITCH_LOG_INFO, 
                  "(%s) deleteFiles - cleanup completed, deleted %d/%zu files\n",
                  m_sessionId.c_str(), deleted_count, m_Files.size());
```

**日志级别**：
- `INFO`：清理开始和完成
- `DEBUG`：每个文件的删除
- `WARNING`：删除失败

**示例输出**：
```
[INFO] (12345-uuid) deleteFiles - cleaning up 3 temporary audio files
[DEBUG] (12345-uuid) deleteFiles - deleted: /tmp/12345-uuid_0.tmp.r8
[DEBUG] (12345-uuid) deleteFiles - deleted: /tmp/12345-uuid_1.tmp.r8
[DEBUG] (12345-uuid) deleteFiles - deleted: /tmp/12345-uuid_2.tmp.r8
[INFO] (12345-uuid) deleteFiles - cleanup completed, deleted 3/3 files
```

---

## 二、日志级别说明

### 2.1 日志级别分类

| 级别 | 用途 | 示例场景 |
|------|------|----------|
| `ERROR` | 错误情况 | JSON 解析失败、Base64 解码失败、缺少必需字段 |
| `WARNING` | 警告信息 | 文件删除失败 |
| `INFO` | 重要信息 | 接收音频、保存文件、触发事件、清理文件 |
| `DEBUG` | 调试信息 | 消息类型、解码大小、事件数据、文件删除详情 |

### 2.2 日志控制

**通道变量**：`STREAM_SUPPRESS_LOG`

```xml
<!-- 抑制详细日志 -->
<action application="set" data="STREAM_SUPPRESS_LOG=true"/>
```

**影响范围**：
- 仅影响 `EVENT_PLAY` 事件数据的 DEBUG 日志
- 不影响 ERROR、WARNING、INFO 级别的日志
- 原有的 WebSocket 响应日志也受此控制

---

## 三、完整日志流程示例

### 3.1 成功场景

```
[DEBUG] (12345-uuid) processMessage - received message type: streamAudio
[INFO] (12345-uuid) processMessage - received streamAudio, type: raw, sampleRate: 8000
[DEBUG] (12345-uuid) processMessage - base64 decoded, size: 3200 bytes
[INFO] (12345-uuid) processMessage - saving audio to file: /tmp/12345-uuid_0.tmp.r8
[INFO] (12345-uuid) processMessage - audio file saved successfully, size: 3200 bytes
[INFO] (12345-uuid) processMessage - triggering EVENT_PLAY event
[DEBUG] (12345-uuid) processMessage - EVENT_PLAY data: {"audioDataType":"raw","sampleRate":8000,"file":"/tmp/12345-uuid_0.tmp.r8"}
[INFO] (12345-uuid) processMessage - EVENT_PLAY event fired successfully
```

### 3.2 错误场景 - JSON 解析失败

```
[ERROR] (12345-uuid) processMessage - failed to parse JSON message
```

### 3.3 错误场景 - 缺少 audioDataType

```
[DEBUG] (12345-uuid) processMessage - received message type: streamAudio
[ERROR] (12345-uuid) processMessage - missing audioDataType in streamAudio message
```

### 3.4 错误场景 - Base64 解码失败

```
[DEBUG] (12345-uuid) processMessage - received message type: streamAudio
[INFO] (12345-uuid) processMessage - received streamAudio, type: raw, sampleRate: 8000
[ERROR] (12345-uuid) processMessage - base64 decode error: Invalid base64 character
```

### 3.5 错误场景 - 不支持的音频类型

```
[DEBUG] (12345-uuid) processMessage - received message type: streamAudio
[ERROR] (12345-uuid) processMessage - unsupported audio type: flac
[ERROR] (12345-uuid) processMessage - failed to determine file type for audioDataType: flac
```

### 3.6 清理场景

```
[INFO] (12345-uuid) deleteFiles - cleaning up 3 temporary audio files
[DEBUG] (12345-uuid) deleteFiles - deleted: /tmp/12345-uuid_0.tmp.r8
[DEBUG] (12345-uuid) deleteFiles - deleted: /tmp/12345-uuid_1.tmp.r8
[WARNING] (12345-uuid) deleteFiles - failed to delete: /tmp/12345-uuid_2.tmp.r8
[INFO] (12345-uuid) deleteFiles - cleanup completed, deleted 2/3 files
```

---

## 四、调试建议

### 4.1 查看实时日志

```bash
# FreeSWITCH CLI
fs_cli> console loglevel debug
fs_cli> uuid_audio_stream <uuid> start ws://...

# 或使用 tail 查看日志文件
tail -f /var/log/freeswitch/freeswitch.log | grep processMessage
```

### 4.2 过滤特定会话日志

```bash
# 按会话 UUID 过滤
tail -f /var/log/freeswitch/freeswitch.log | grep "12345-uuid"

# 只看播放相关日志
tail -f /var/log/freeswitch/freeswitch.log | grep -E "streamAudio|EVENT_PLAY|deleteFiles"
```

### 4.3 日志级别调整

```bash
# FreeSWITCH CLI 中调整日志级别
fs_cli> fsctl loglevel debug        # 全局 DEBUG
fs_cli> fsctl loglevel info         # 全局 INFO
fs_cli> fsctl loglevel <uuid> debug # 单个会话 DEBUG
```

---

## 五、性能影响

### 5.1 日志开销

| 日志级别 | 性能影响 | 建议使用场景 |
|----------|----------|--------------|
| ERROR | 极低 | 生产环境 |
| WARNING | 极低 | 生产环境 |
| INFO | 低 | 生产环境（推荐） |
| DEBUG | 中等 | 开发/测试环境 |

### 5.2 优化建议

1. **生产环境**：使用 INFO 级别
   ```bash
   fs_cli> fsctl loglevel info
   ```

2. **开发环境**：使用 DEBUG 级别
   ```bash
   fs_cli> fsctl loglevel debug
   ```

3. **高并发场景**：启用日志抑制
   ```xml
   <action application="set" data="STREAM_SUPPRESS_LOG=true"/>
   ```

---

## 六、故障排查指南

### 6.1 音频文件未生成

**检查日志**：
```
[ERROR] processMessage - failed to parse JSON message
[ERROR] processMessage - missing audioDataType
[ERROR] processMessage - base64 decode error
```

**可能原因**：
- WebSocket 服务器发送的 JSON 格式错误
- 缺少必需字段（type、data、audioDataType、audioData）
- Base64 编码错误

### 6.2 事件未触发

**检查日志**：
```
[INFO] processMessage - triggering EVENT_PLAY event
[INFO] processMessage - EVENT_PLAY event fired successfully
```

**如果没有这些日志**：
- 文件保存可能失败
- jsonFile 为空

### 6.3 文件清理失败

**检查日志**：
```
[WARNING] deleteFiles - failed to delete: /tmp/uuid_0.tmp.r8
```

**可能原因**：
- 文件被其他进程占用
- 权限不足
- 文件已被删除

---

## 七、日志示例：完整会话

```
# 启动音频流
[INFO] stream_session_init - initializing audio stream
[INFO] AudioStreamer - connecting to ws://localhost:8080/audio

# 连接成功
[INFO] AudioStreamer - connection established

# 接收第一个音频
[DEBUG] (12345-uuid) processMessage - received message type: streamAudio
[INFO] (12345-uuid) processMessage - received streamAudio, type: raw, sampleRate: 8000
[DEBUG] (12345-uuid) processMessage - base64 decoded, size: 3200 bytes
[INFO] (12345-uuid) processMessage - saving audio to file: /tmp/12345-uuid_0.tmp.r8
[INFO] (12345-uuid) processMessage - audio file saved successfully, size: 3200 bytes
[INFO] (12345-uuid) processMessage - triggering EVENT_PLAY event
[DEBUG] (12345-uuid) processMessage - EVENT_PLAY data: {"audioDataType":"raw","sampleRate":8000,"file":"/tmp/12345-uuid_0.tmp.r8"}
[INFO] (12345-uuid) processMessage - EVENT_PLAY event fired successfully

# 接收第二个音频
[DEBUG] (12345-uuid) processMessage - received message type: streamAudio
[INFO] (12345-uuid) processMessage - received streamAudio, type: wav, sampleRate: 0
[DEBUG] (12345-uuid) processMessage - base64 decoded, size: 8044 bytes
[INFO] (12345-uuid) processMessage - saving audio to file: /tmp/12345-uuid_1.tmp.wav
[INFO] (12345-uuid) processMessage - audio file saved successfully, size: 8044 bytes
[INFO] (12345-uuid) processMessage - triggering EVENT_PLAY event
[INFO] (12345-uuid) processMessage - EVENT_PLAY event fired successfully

# 停止音频流
[INFO] stream_session_cleanup - cleaning up session
[INFO] (12345-uuid) deleteFiles - cleaning up 2 temporary audio files
[DEBUG] (12345-uuid) deleteFiles - deleted: /tmp/12345-uuid_0.tmp.r8
[DEBUG] (12345-uuid) deleteFiles - deleted: /tmp/12345-uuid_1.tmp.wav
[INFO] (12345-uuid) deleteFiles - cleanup completed, deleted 2/2 files
[INFO] stream_session_cleanup - connection closed
```

---

## 八、总结

### 8.1 新增日志统计

| 位置 | 新增日志数 | 主要级别 |
|------|-----------|----------|
| processMessage 入口 | 2 | ERROR, DEBUG |
| 音频类型验证 | 2 | ERROR |
| 音频数据接收 | 1 | INFO |
| Base64 解码 | 1 | DEBUG |
| 文件保存 | 2 | INFO |
| 事件推送 | 3 | INFO, DEBUG |
| 文件清理 | 4 | INFO, DEBUG, WARNING |
| **总计** | **15** | - |

### 8.2 关键改进

1. ✅ **完整的流程追踪**：从接收消息到文件保存再到事件触发
2. ✅ **详细的错误信息**：每个失败点都有明确的错误日志
3. ✅ **性能监控**：记录文件大小、处理时间等关键指标
4. ✅ **资源管理**：清理过程的详细记录
5. ✅ **可配置性**：通过 STREAM_SUPPRESS_LOG 控制详细程度

### 8.3 使用建议

- **开发阶段**：使用 DEBUG 级别，查看所有细节
- **测试阶段**：使用 INFO 级别，关注关键流程
- **生产环境**：使用 INFO 级别，必要时启用 SUPPRESS_LOG
- **故障排查**：临时提升到 DEBUG 级别

---

**修改完成时间**：2025-02-22  
**影响文件**：audio_streamer_glue.cpp  
**向后兼容**：是（仅新增日志，不改变功能）
